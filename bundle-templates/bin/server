#!/usr/bin/env bash
set -euo pipefail
source "$(dirname "$0")/common.sh"

need REDASH_DATABASE_URL
need REDASH_REDIS_URL
need REDASH_COOKIE_SECRET
need REDASH_SECRET_KEY

ensure_venv
cd "$APP_DIR"

WORKERS="${REDASH_WEB_WORKERS:-4}"
TIMEOUT="${REDASH_GUNICORN_TIMEOUT:-60}"
BIND="${REDASH_BIND:-0.0.0.0:5000}"

exec "$VENV_DIR/bin/gunicorn" \
  --bind "$BIND" \
  --workers "$WORKERS" \
  --timeout "$TIMEOUT" \
  --name redash \
  --max-requests 1000 \
  --max-requests-jitter 100 \
  redash.wsgi:app
